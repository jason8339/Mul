# ç¢°æ’æª¢æ¸¬èª¿è©¦æŒ‡å—

## ğŸ”§ æœ¬æ¬¡ä¿®å¾©å…§å®¹

### æ ¸å¿ƒæ”¹é€²ï¼ˆåŸºæ–¼GPTå»ºè­°ï¼‰

#### 1. **ä½¿ç”¨åŠå°–ä½ç½®è€Œéè³ªå¿ƒ** âœ…
```swift
// ä¹‹å‰ï¼šå¾åŠçš„è³ªå¿ƒç™¼å°„å°„ç·šï¼ˆéŒ¯èª¤ï¼‰
let rayOrigin = swordPosition + direction * 0.45

// ç¾åœ¨ï¼šå¾åŠå°–çš„ä¸Šä¸€å¹€ä½ç½®ç™¼å°„ï¼ˆæ­£ç¢ºï¼‰
let tipPrev = component.lastTipWorld ?? tipNow
let rayOrigin = tipPrev
```

#### 2. **å‹•æ…‹å°„ç·šé•·åº¦** âœ…
```swift
// ä¹‹å‰ï¼šå›ºå®š15cmï¼ˆå¤ªçŸ­ï¼Œæœƒmissï¼‰
let raycastDistance: Float = 0.15

// ç¾åœ¨ï¼šæ ¹æ“šå¯¦éš›ä½ç§»è¨ˆç®—ï¼ˆä¸Šä¸€å¹€â†’æœ¬å¹€é æœŸä½ç½®ï¼‰
let displacement = tipNextExpected - tipPrev
let rayLength = length(displacement) + 0.1  // ä½ç§» + 10cm buffer
```

#### 3. **ç§»é™¤CollisionGroupéæ¿¾** âœ…
```swift
// èª¿è©¦éšæ®µä¸ä½¿ç”¨maskï¼Œç¢ºä¿èƒ½æª¢æ¸¬åˆ°æ‰€æœ‰ç‰©é«”
let results = scene.raycast(
    origin: tipPrev,
    direction: direction,
    length: rayLength,
    query: .nearest,
    relativeTo: nil
    // æ²’æœ‰maskåƒæ•¸
)
```

#### 4. **è¨˜éŒ„ä¸¦æ›´æ–°åŠå°–ä½ç½®** âœ…
```swift
// FlyingSwordComponent æ–°å¢å­—æ®µ
var lastTipWorld: SIMD3<Float>? = nil
var swordTipOffset: Float { config.swordLength / 2.0 }

// æ¯å¹€æ›´æ–°
component.lastTipWorld = tipNow
```

---

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

### 1. **å•Ÿå‹•æ‡‰ç”¨ä¸¦æª¢æŸ¥æ—¥èªŒ**

å•Ÿå‹•æ‡‰ç”¨æ™‚ï¼Œæ‡‰è©²çœ‹åˆ°ä»¥ä¸‹æ—¥èªŒï¼š

```
ğŸ” å¼€å§‹ä¸ºåœºæ™¯æ·»åŠ ç¢°æ’ç»„ä»¶...
ğŸ“¦ å®ä½“: [å¯¦é«”åç¨±] å°ºå¯¸: SIMD3<Float>(...)
âœ… æ·»åŠ ç¢°æ’: [å¯¦é«”åç¨±] å°ºå¯¸: ...
âœ… åœºæ™¯ç¢°æ’æ·»åŠ å®Œæˆï¼šå…±æ‰«æ X ä¸ªå®ä½“ï¼Œæ·»åŠ  Y ä¸ªç¢°æ’ä½“
âœ… é£å‰‘ç¢°æ’ç»„ä»¶å·²æ·»åŠ ï¼ˆè°ƒè¯•æ¨¡å¼ï¼šæ— è¿‡æ»¤å™¨ï¼‰
```

**é—œéµæª¢æŸ¥é»**:
- âœ… ç¢°æ’é«”æ•¸é‡ > 0ï¼ˆå ´æ™¯ç‰©é«”æœ‰ç¢°æ’ï¼‰
- âœ… é£›åŠç¢°æ’çµ„ä»¶å·²æ·»åŠ 

### 2. **ç™¼å°„é£›åŠ**

å‘ç‰†å£æˆ–å ´æ™¯ç‰©é«”ç™¼å°„é£›åŠï¼Œè§€å¯Ÿæ—¥èªŒï¼š

**æ­£å¸¸æƒ…æ³**ï¼ˆæ‡‰è©²çœ‹åˆ°ï¼‰:
```
ğŸš€ ç™¼å°„é£›åŠï¼é€Ÿåº¦: XXX cm/sï¼Œé‡é‡: 0.5 kg
ğŸ’¥ æ£€æµ‹åˆ°ç¢°æ’: [ç‰©é«”åç¨±] è·ç¦»: XX.XXcm
   å°„çº¿: ä» SIMD3(...) åˆ° SIMD3(...), é•¿åº¦: XX.XXcm
ğŸ’¥ é£å‰‘ç¢°æ’ï¼åœæ­¢é£è¡Œ
âœ… é£›åŠé£›è¡ŒçµæŸï¼Œå›åˆ°è·Ÿéš¨æ¨¡å¼
```

**ç•°å¸¸æƒ…æ³**ï¼ˆä¸æ‡‰è©²çœ‹åˆ°ï¼‰:
```
âš ï¸ å‡»ä¸­çš„æ˜¯é£å‰‘è‡ªå·±ï¼Œå¿½ç•¥  âŒ é€™å€‹ä¸æ‡‰è©²å†å‡ºç¾
```

### 3. **å¦‚æœä»ç„¶æª¢æ¸¬ä¸åˆ°ç¢°æ’**

#### å•é¡ŒAï¼šå ´æ™¯æ²’æœ‰ç¢°æ’é«”

**ç—‡ç‹€**: æ—¥èªŒé¡¯ç¤º `æ·»åŠ  0 ä¸ªç¢°æ’ä½“`

**è§£æ±ºæ–¹æ¡ˆ**:
1. ç¢ºèªå ´æ™¯åç¨±æ˜¯å¦æ­£ç¢ºï¼ˆ`Oldfactory`ï¼‰
2. æª¢æŸ¥å ´æ™¯æª”æ¡ˆæ˜¯å¦åŒ…å«ModelEntity
3. å˜—è©¦æ‰‹å‹•æ·»åŠ æ¸¬è©¦ç‰©é«”ï¼š

```swift
// åœ¨ loadScene å‡½æ•¸ä¸­æ·»åŠ æ¸¬è©¦ç«‹æ–¹é«”
let testBox = ModelEntity(
    mesh: .generateBox(size: 0.5),
    materials: [SimpleMaterial(color: .red, isMetallic: false)]
)
testBox.position = [0, 1.5, -2]  // æ”¾åœ¨å‰æ–¹2ç±³è™•
testBox.components.set(CollisionComponent(
    shapes: [.generateBox(size: [0.5, 0.5, 0.5])],
    mode: .default
))
content.add(testBox)
print("âœ… æ·»åŠ æ¸¬è©¦ç«‹æ–¹é«”ç”¨æ–¼ç¢°æ’æª¢æ¸¬")
```

#### å•é¡ŒBï¼šå°„ç·šæ²’æœ‰æ“Šä¸­ä»»ä½•ç‰©é«”

**ç—‡ç‹€**: é£›åŠç©¿éç‰†å£ï¼Œæ²’æœ‰ä»»ä½•ç¢°æ’æ—¥èªŒ

**èª¿è©¦ä»£ç¢¼**ï¼ˆæ·»åŠ åˆ° checkCollision å‡½æ•¸ï¼‰:
```swift
// åœ¨ raycast ä¹‹å‰æ·»åŠ 
print("ğŸ” å°„ç·šæª¢æ¸¬:")
print("   èµ·é»: \(tipPrev)")
print("   æ–¹å‘: \(direction)")
print("   é•·åº¦: \(rayLength * 100)cm")
print("   é€Ÿåº¦: \(length(component.velocity) * 100)cm/s")

let results = scene.raycast(...)

print("   çµæœæ•¸: \(results.count)")
for (i, hit) in results.enumerated() {
    print("   [\(i)] \(hit.entity.name) @ \(hit.distance * 100)cm")
}
```

#### å•é¡ŒCï¼šå°„ç·šé•·åº¦ä¸è¶³

**ç—‡ç‹€**: é«˜é€Ÿé£›è¡Œæ™‚ç©¿ç‰†ï¼Œä½é€Ÿæ™‚èƒ½æª¢æ¸¬åˆ°

**è§£æ±ºæ–¹æ¡ˆ**: å·²ç¶“åœ¨ä»£ç¢¼ä¸­ä¿®å¾©ï¼ˆå‹•æ…‹é•·åº¦ = ä½ç§» + 10cmï¼‰

æª¢æŸ¥é€Ÿåº¦æ˜¯å¦ç•°å¸¸é«˜ï¼š
```swift
let speed = length(component.velocity)
if speed > 10.0 {  // > 10 m/s = 1000 cm/s
    print("âš ï¸ é£›åŠé€Ÿåº¦éé«˜: \(speed * 100)cm/sï¼Œå¯èƒ½ç©¿ç‰†")
}
```

#### å•é¡ŒDï¼šåŠå°–åç§»è¨ˆç®—éŒ¯èª¤

**ç—‡ç‹€**: å°„ç·šå¾éŒ¯èª¤çš„ä½ç½®ç™¼å°„

**é©—è­‰æ–¹æ³•**:
```swift
// åœ¨ checkCollision ä¸­æ·»åŠ 
let actualTipOffset = component.swordTipOffset
let expectedTipOffset = component.config.swordLength / 2.0
print("åŠå°–åç§»: å¯¦éš›=\(actualTipOffset)m, é æœŸ=\(expectedTipOffset)m")

// æª¢æŸ¥åŠçš„å¯¦éš›é•·åº¦é…ç½®
print("åŠé•·åº¦é…ç½®: \(component.config.swordLength)m")
```

---

## ğŸ“Š èª¿è©¦æª¢æŸ¥æ¸…å–®

ä½¿ç”¨æ­¤æ¸…å–®é€ä¸€æ’æŸ¥ï¼š

- [ ] **å ´æ™¯åŠ è¼‰æˆåŠŸ**
  - æ—¥èªŒ: `âœ… åœºæ™¯ 'Oldfactory' åŠ è½½æˆåŠŸ`

- [ ] **ç¢°æ’é«”å·²æ·»åŠ **
  - æ—¥èªŒ: `âœ… åœºæ™¯ç¢°æ’æ·»åŠ å®Œæˆï¼šå…±æ‰«æ X ä¸ªå®ä½“ï¼Œæ·»åŠ  Y ä¸ªç¢°æ’ä½“`
  - Y > 0

- [ ] **é£›åŠç¢°æ’çµ„ä»¶å·²æ·»åŠ **
  - æ—¥èªŒ: `âœ… é£å‰‘ç¢°æ’ç»„ä»¶å·²æ·»åŠ `

- [ ] **ç™¼å°„é£›åŠæ™‚è¨˜éŒ„åŠå°–ä½ç½®**
  - lastTipWorld ä¸ç‚º nil

- [ ] **å°„ç·šæª¢æ¸¬åŸ·è¡Œ**
  - çœ‹åˆ° `ğŸ’¥ æ£€æµ‹åˆ°ç¢°æ’` æˆ–è‡³å°‘å°„ç·šèª¿è©¦ä¿¡æ¯

- [ ] **ç¢°æ’å¾Œé£›åŠåœæ­¢**
  - æ—¥èªŒ: `ğŸ’¥ é£å‰‘ç¢°æ’ï¼åœæ­¢é£è¡Œ`
  - é£›åŠå›åˆ°è·Ÿéš¨æ¨¡å¼

---

## ğŸ¯ é æœŸè¡Œç‚ºå°æ¯”

### âœ… ä¿®å¾©å¾Œçš„æ­£å¸¸æµç¨‹

1. å•Ÿå‹•æ‡‰ç”¨ â†’ å ´æ™¯åŠ è¼‰ â†’ N å€‹ç¢°æ’é«”æ·»åŠ 
2. ç™¼å°„é£›åŠ â†’ è¨˜éŒ„åŠå°–åˆå§‹ä½ç½®
3. æ¯å¹€æ›´æ–° â†’ å¾ä¸Šä¸€å¹€åŠå°–åˆ°é æœŸä½ç½®åšå°„ç·šæª¢æ¸¬
4. æ“Šä¸­ç‰†å£ â†’ æª¢æ¸¬åˆ°ç¢°æ’ â†’ åœæ­¢é£›è¡Œ
5. é£›åŠè¿”å›è·Ÿéš¨æ¨¡å¼

### âŒ ä¿®å¾©å‰çš„éŒ¯èª¤æµç¨‹

1. ç™¼å°„é£›åŠ
2. å¾åŠè³ªå¿ƒç™¼å°„å›ºå®š15cmçš„å°„ç·š
3. å°„ç·šå¤ªçŸ­ï¼Œmissæ‰é è™•éšœç¤™ç‰©
4. æˆ–å°„ç·šç«‹å³æ“Šä¸­åŠè‡ªå·±çš„ç¢°æ’ç›’
5. é£›åŠç©¿ç‰†

---

## ğŸ”¬ é«˜ç´šèª¿è©¦æŠ€å·§

### å¯è¦–åŒ–å°„ç·šï¼ˆéœ€è¦æ‰‹å‹•å¯¦ç¾ï¼‰

```swift
// åœ¨å ´æ™¯ä¸­ç¹ªè£½èª¿è©¦å°„ç·šï¼ˆä½¿ç”¨ç´°é•·çš„ boxï¼‰
func drawDebugRay(from: SIMD3<Float>, to: SIMD3<Float>, in scene: Scene) {
    let direction = to - from
    let distance = length(direction)
    let midPoint = from + direction * 0.5

    let debugLine = ModelEntity(
        mesh: .generateBox(size: [0.01, 0.01, distance]),
        materials: [SimpleMaterial(color: .yellow, isMetallic: false)]
    )
    debugLine.position = midPoint
    debugLine.look(at: to, from: from, relativeTo: nil)

    scene.addChild(debugLine)

    // 1ç§’å¾Œç§»é™¤
    Task {
        try? await Task.sleep(nanoseconds: 1_000_000_000)
        debugLine.removeFromParent()
    }
}
```

### è¨˜éŒ„ç¢°æ’çµ±è¨ˆ

```swift
// åœ¨ FlyingSwordSystem ä¸­æ·»åŠ 
private var collisionStats = (hits: 0, misses: 0, totalRays: 0)

// åœ¨ checkCollision ä¸­
collisionStats.totalRays += 1
if hit != nil {
    collisionStats.hits += 1
} else {
    collisionStats.misses += 1
}

// å®šæœŸæ‰“å°
if collisionStats.totalRays % 100 == 0 {
    print("ç¢°æ’çµ±è¨ˆ: æª¢æ¸¬\(collisionStats.totalRays)æ¬¡, å‘½ä¸­\(collisionStats.hits)æ¬¡")
}
```

---

## ğŸ’¡ å¸¸è¦‹å•é¡Œ FAQ

### Q1: ç‚ºä»€éº¼è¦ä½¿ç”¨åŠå°–ä½ç½®è€Œä¸æ˜¯è³ªå¿ƒï¼Ÿ

**A**: åŠæ˜¯ä¸€å€‹é•·æ¢å½¢ç‰©é«”ï¼Œè³ªå¿ƒåœ¨ä¸­é–“ã€‚å¦‚æœå¾è³ªå¿ƒç™¼å°„å°„ç·šï¼š
- åŠå°–å¯èƒ½å·²ç¶“æ’å…¥ç‰†å£ï¼Œä½†è³ªå¿ƒé‚„åœ¨å¤–é¢
- å°„ç·šæœƒmissæ‰åŠå°–å‰æ–¹çš„éšœç¤™ç‰©
- ä½¿ç”¨åŠå°–ä½ç½®èƒ½æ›´æº–ç¢ºæª¢æ¸¬"å³å°‡ç¢°æ’"çš„æƒ…æ³

### Q2: ç‚ºä»€éº¼è¦ä½¿ç”¨å‹•æ…‹å°„ç·šé•·åº¦ï¼Ÿ

**A**: å›ºå®š15cmçš„å•é¡Œï¼š
- é£›åŠé€Ÿåº¦è®ŠåŒ–å¤§ï¼ˆæ…¢é€Ÿ0.1m/s ~ å¿«é€Ÿ3m/sï¼‰
- é«˜é€Ÿæ™‚ï¼Œä¸€å¹€ä½ç§»å¯èƒ½è¶…é15cmï¼Œå°è‡´ç©¿ç‰†
- å‹•æ…‹é•·åº¦ = å¯¦éš›ä½ç§»ï¼Œç¢ºä¿ä¸æ¼æª¢

### Q3: ä»€éº¼æ™‚å€™æ¢å¾©CollisionGroupéæ¿¾ï¼Ÿ

**A**: èª¿è©¦å®Œæˆï¼Œç¢ºèªç¢°æ’æ­£å¸¸å·¥ä½œå¾Œï¼š
1. åœ¨ `HandTrackingView.swift` æ¢å¾©å ´æ™¯çš„ filter
2. åœ¨ `HandTrackingSystem.swift` æ¢å¾©é£›åŠçš„ filter
3. è¨­ç½®æ­£ç¢ºçš„ group å’Œ mask

```swift
// å ´æ™¯ç‰©é«”
filter: .init(
    group: CollisionGroup(rawValue: 1 << 0),
    mask: CollisionGroup(rawValue: 1 << 1)
)

// é£›åŠ
filter: .init(
    group: CollisionGroup(rawValue: 1 << 1),
    mask: CollisionGroup(rawValue: 1 << 0)
)
```

### Q4: å¦‚æœå ´æ™¯æ²’æœ‰ä»»ä½•ModelEntityæ€éº¼è¾¦ï¼Ÿ

**A**: å ´æ™¯å¯èƒ½ä½¿ç”¨äº†ä¸åŒçš„çµæ§‹ã€‚å˜—è©¦ï¼š
1. æ‰“å°å ´æ™¯å±¤ç´šçµæ§‹
2. ä½¿ç”¨ `generateCollisionShapes(recursive: true)`
3. æ·»åŠ æ¸¬è©¦ç‰©é«”ï¼ˆè¦‹ä¸Šæ–¹"å•é¡ŒA"çš„è§£æ±ºæ–¹æ¡ˆï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥å„ªåŒ–

ç¢°æ’æª¢æ¸¬æ­£å¸¸å·¥ä½œå¾Œï¼Œå¯ä»¥è€ƒæ…®ï¼š

1. **æ·»åŠ ç¢°æ’ç‰¹æ•ˆ**
   - ç«èŠ±ç²’å­
   - ç¢°æ’éŸ³æ•ˆ
   - éœ‡å‹•åé¥‹

2. **å¯¦ç¾æ’å…¥ç‰†å£æ•ˆæœ**
   - æª¢æ¸¬åˆ°ç¢°æ’å¾Œï¼Œå°‡åŠå®šä½åœ¨ç¢°æ’é»
   - æ”¹ç‚º kinematic æ¨¡å¼é–å®š
   - å¯¦ç¾"æ‹”åŠ"æ‰‹å‹¢

3. **æ€§èƒ½å„ªåŒ–**
   - åªåœ¨é£›è¡Œæ™‚åŸ·è¡Œç¢°æ’æª¢æ¸¬
   - ä½¿ç”¨CollisionGroupç²¾ç¢ºéæ¿¾
   - æ¸›å°‘ä¸å¿…è¦çš„printèªå¥

4. **åˆ‡æ›åˆ°ç‰©ç†å¼•æ“**ï¼ˆå¯é¸ï¼‰
   - åƒè€ƒ `COLLISION_PHYSICS_GUIDE.md`
   - ç²å¾—æ›´çœŸå¯¦çš„ç‰©ç†æ•ˆæœ

---

**ç¸½çµ**: ç¾åœ¨çš„ç¢°æ’æª¢æ¸¬ä½¿ç”¨äº†æ­£ç¢ºçš„åŠå°–ä½ç½®å’Œå‹•æ…‹å°„ç·šé•·åº¦ï¼Œæ‡‰è©²èƒ½å¯é åœ°æª¢æ¸¬åˆ°éšœç¤™ç‰©ã€‚å¦‚æœä»æœ‰å•é¡Œï¼Œè«‹æŒ‰ç…§ä¸Šè¿°èª¿è©¦æ­¥é©Ÿé€ä¸€æ’æŸ¥ï¼
